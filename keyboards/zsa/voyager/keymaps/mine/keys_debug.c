#include <stdint.h>
#include "action.h"

#ifdef CONSOLE_ENABLE
#    include "action_layer.h"
#    include "print.h"
#    include "tapping.h"

// clang-format off
static const uint8_t layer_coords[] = {
    0xFF, 0xFF, 0x00, 0x00, 0x00, 0x01, 0x00, 0x02, 0x00, 0x03, 0x00, 0x04, 0x00, 0x05,
    0xFF, 0xFF, 0x01, 0x00, 0x01, 0x01, 0x01, 0x02, 0x01, 0x03, 0x01, 0x04, 0x01, 0x05,
    0xFF, 0xFF, 0x02, 0x00, 0x02, 0x01, 0x02, 0x02, 0x02, 0x03, 0x02, 0x04, 0x02, 0x05,
    0xFF, 0xFF, 0x03, 0x00, 0x03, 0x01, 0x03, 0x02, 0x03, 0x03, 0x03, 0x04, 0xFF, 0xFF,
    0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0x03, 0x05, 0xFF, 0xFF, 0xFF, 0xFF,
    0x04, 0x04, 0x04, 0x05, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,
    0x00, 0x06, 0x00, 0x07, 0x00, 0x08, 0x00, 0x09, 0x00, 0x0A, 0x00, 0x0B, 0xFF, 0xFF,
    0x01, 0x06, 0x01, 0x07, 0x01, 0x08, 0x01, 0x09, 0x01, 0x0A, 0x01, 0x0B, 0xFF, 0xFF,
    0x02, 0x06, 0x02, 0x07, 0x02, 0x08, 0x02, 0x09, 0x02, 0x0A, 0x02, 0x0B, 0xFF, 0xFF,
    0xFF, 0xFF, 0x03, 0x07, 0x03, 0x08, 0x03, 0x09, 0x03, 0x0A, 0x03, 0x0B, 0xFF, 0xFF,
    0xFF, 0xFF, 0xFF, 0xFF, 0x03, 0x06, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,
    0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0x04, 0x06, 0x04, 0x07
};
// clang-format on

static inline void get_layout_coords(uint8_t row, uint8_t col, uint8_t *layout_row, uint8_t *layout_col) {
    *layout_row = layer_coords[row * MATRIX_COLS * 2 + col * 2 + 1];
    *layout_col = layer_coords[row * MATRIX_COLS * 2 + col * 2 + 0];
}

static uint32_t key_press_time[MATRIX_ROWS][MATRIX_COLS];

void pre_debug_key(uint16_t keycode, keyrecord_t *record) {
    if (record->event.pressed) {
        uint8_t row              = record->event.key.row;
        uint8_t col              = record->event.key.col;
        key_press_time[row][col] = timer_read32();
    }
}

void post_debug_key(uint16_t keycode, keyrecord_t *record) {
    if (!record->event.pressed) {
        uint8_t row           = record->event.key.row;
        uint8_t col           = record->event.key.col;
        uint8_t current_layer = get_highest_layer(layer_state);

        uint32_t press_duration = timer_elapsed32(key_press_time[row][col]);
        uint8_t  layout_row, layout_col;
        get_layout_coords(row, col, &layout_row, &layout_col);

        uint16_t tapping_term = TAPPING_TERM + (int8_t)pgm_read_byte(&tapping_term_delays[row][col]);

        bool hold = press_duration > tapping_term;

        uprintf("{\"layer\":%u,\"x\":%u,\"y\":%u,\"duration\":%lu,\"hold\":%s,\"tapping_term\":%u}\n", current_layer,
                layout_col, layout_row, (unsigned long)press_duration, hold ? "true" : "false", tapping_term);
    }
}
#else
void pre_debug_key(uint16_t keycode, keyrecord_t *record) {}
void post_debug_key(uint16_t keycode, keyrecord_t *record) {}
#endif
